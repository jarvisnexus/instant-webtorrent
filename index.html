<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebTorrent Fullscreen Player</title>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent/webtorrent.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/video.js/dist/video.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/video.js/dist/video-js.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #video-player {
            width: 100%;
            height: 100%;
        }

        .vjs-default-skin {
            color: #fff;
        }
    </style>
</head>
<body>
    <video id="video-player" class="video-js vjs-default-skin" controls preload="auto"></video>

    <script>
        // Get the infoHash and fileIndex from URL query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const infoHash = urlParams.get('infoHash'); // Expecting the query parameter infoHash
        const fileIndex = parseInt(urlParams.get('fileIndex')) || 0; // Default to 0 if not provided

        if (!infoHash) {
            console.error('No infoHash provided in the URL.');
            return;
        }

        const client = new WebTorrent();
        const player = videojs('video-player');

        // Add the torrent by infoHash
        client.add(infoHash, { infoHash: true }, torrent => {
            // Filter for video files (e.g., .mp4)
            const videoFiles = torrent.files.filter(file => file.name.endsWith('.mp4'));

            // Check if the requested fileIndex is valid
            if (videoFiles.length > fileIndex) {
                playFile(videoFiles[fileIndex]);
            } else {
                console.error('Invalid file index or no video files available.');
            }
        });

        function playFile(file) {
            file.getBlobURL((err, url) => {
                if (err) {
                    console.error('Error generating blob URL:', err);
                    return;
                }

                // Set the video source and type for video.js
                player.src({
                    src: url,
                    type: 'video/mp4'
                });

                // Optionally, add subtitle tracks if available
                file.getBlobURL((err, blob) => {
                    if (!err && file.name.endsWith('.srt')) {
                        player.addRemoteTextTrack({
                            src: blob,
                            kind: 'subtitles',
                            srclang: 'en',
                            label: file.name
                        }, false);
                    }
                });

                // Start playing the video
                player.play();
            });
        }
    </script>
</body>
</html>
